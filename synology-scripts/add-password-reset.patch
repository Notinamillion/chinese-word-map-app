// FIX: Add password reset functionality with Resend email service
// TO BE APPLIED: 2026-01-04

// ===== STEP 1: Install Resend SDK =====
// SSH into Synology and run:
// cd /volume1/web/chinese-word-map
// npm install resend

// ===== STEP 2: Add Resend API key to environment =====
// Add to server-synology.js (top of file):
const { Resend } = require('resend');
const resend = new Resend('re_YOUR_API_KEY_HERE'); // Get from resend.com dashboard

// ===== STEP 3: Add database schema for reset tokens =====
// Add this after database initialization in server-synology.js:

// Create password_reset_tokens table
db.exec(`
  CREATE TABLE IF NOT EXISTS password_reset_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    token TEXT NOT NULL UNIQUE,
    expires_at INTEGER NOT NULL,
    used INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (strftime('%s', 'now')),
    FOREIGN KEY (user_id) REFERENCES users(id)
  )
`);

console.log('[DB] Password reset tokens table initialized');

// ===== STEP 4: Add password reset endpoints =====

// POST /api/auth/forgot-password - Request password reset
app.post('/api/auth/forgot-password', async (req, res) => {
  try {
    const { email } = req.body;

    if (!email) {
      return res.status(400).json({ success: false, message: 'Email is required' });
    }

    // Find user by email
    const result = db.exec('SELECT id, username, email FROM users WHERE email = ?', [email]);

    if (!result.length) {
      // Don't reveal if email exists - security best practice
      return res.json({
        success: true,
        message: 'If an account exists with this email, you will receive a password reset link.'
      });
    }

    const userId = result[0][0];
    const username = result[0][1];

    // Generate secure token (32 random bytes)
    const crypto = require('crypto');
    const token = crypto.randomBytes(32).toString('hex');

    // Token expires in 30 minutes
    const expiresAt = Math.floor(Date.now() / 1000) + (30 * 60);

    // Save token to database
    db.exec(
      'INSERT INTO password_reset_tokens (user_id, token, expires_at) VALUES (?, ?, ?)',
      [userId, token, expiresAt]
    );

    // Send email via Resend
    const resetUrl = `https://chinese-app.synology.me/reset-password?token=${token}`;

    try {
      await resend.emails.send({
        from: 'Chinese Word Map <admin@zhongmap.com>',
        to: email,
        subject: 'Reset Your Password - Chinese Word Map',
        html: `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .container { max-width: 600px; margin: 0 auto; padding: 20px; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }
              .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 8px 8px; }
              .button { display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; margin: 20px 0; }
              .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üîê Password Reset Request</h1>
              </div>
              <div class="content">
                <p>Hello <strong>${username}</strong>,</p>
                <p>We received a request to reset your password for Chinese Word Map. Click the button below to create a new password:</p>
                <p style="text-align: center;">
                  <a href="${resetUrl}" class="button">Reset Password</a>
                </p>
                <p>Or copy and paste this link into your browser:</p>
                <p style="word-break: break-all; color: #667eea;">${resetUrl}</p>
                <p><strong>This link will expire in 30 minutes.</strong></p>
                <p>If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.</p>
              </div>
              <div class="footer">
                <p>Chinese Word Map - Learn Chinese Characters</p>
                <p>This is an automated email, please do not reply.</p>
              </div>
            </div>
          </body>
          </html>
        `
      });

      console.log(`[AUTH] Password reset email sent to ${email}`);
    } catch (emailError) {
      console.error('[AUTH] Failed to send reset email:', emailError);
      return res.status(500).json({
        success: false,
        message: 'Failed to send reset email. Please try again later.'
      });
    }

    res.json({
      success: true,
      message: 'If an account exists with this email, you will receive a password reset link.'
    });
  } catch (error) {
    console.error('[AUTH] Forgot password error:', error);
    res.status(500).json({ success: false, message: 'Server error' });
  }
});

// POST /api/auth/reset-password - Reset password with token
app.post('/api/auth/reset-password', async (req, res) => {
  try {
    const { token, newPassword } = req.body;

    if (!token || !newPassword) {
      return res.status(400).json({ success: false, message: 'Token and new password are required' });
    }

    // Validate password length
    if (newPassword.length < 6) {
      return res.status(400).json({ success: false, message: 'Password must be at least 6 characters' });
    }

    // Find valid token
    const now = Math.floor(Date.now() / 1000);
    const result = db.exec(
      'SELECT user_id, expires_at, used FROM password_reset_tokens WHERE token = ?',
      [token]
    );

    if (!result.length) {
      return res.status(400).json({ success: false, message: 'Invalid or expired reset token' });
    }

    const userId = result[0][0];
    const expiresAt = result[0][1];
    const used = result[0][2];

    // Check if token is expired or already used
    if (used === 1) {
      return res.status(400).json({ success: false, message: 'This reset link has already been used' });
    }

    if (expiresAt < now) {
      return res.status(400).json({ success: false, message: 'This reset link has expired' });
    }

    // Hash new password
    const crypto = require('crypto');
    const passwordHash = crypto.createHash('sha256').update(newPassword).digest('hex');

    // Update user password
    db.exec('UPDATE users SET password_hash = ? WHERE id = ?', [passwordHash, userId]);

    // Mark token as used
    db.exec('UPDATE password_reset_tokens SET used = 1 WHERE token = ?', [token]);

    console.log(`[AUTH] Password reset successful for user ID ${userId}`);

    res.json({ success: true, message: 'Password reset successful. You can now log in with your new password.' });
  } catch (error) {
    console.error('[AUTH] Reset password error:', error);
    res.status(500).json({ success: false, message: 'Server error' });
  }
});

// GET /reset-password - Web page for password reset (optional)
app.get('/reset-password', (req, res) => {
  const { token } = req.query;

  if (!token) {
    return res.status(400).send('Invalid reset link');
  }

  // Serve a simple HTML page
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Reset Password - Chinese Word Map</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }
        .container {
          background: white;
          border-radius: 16px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          max-width: 400px;
          width: 100%;
          padding: 40px;
        }
        h1 { color: #667eea; margin-bottom: 24px; font-size: 28px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        input {
          width: 100%;
          padding: 12px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 16px;
          transition: border-color 0.3s;
        }
        input:focus {
          outline: none;
          border-color: #667eea;
        }
        button {
          width: 100%;
          background: #667eea;
          color: white;
          border: none;
          padding: 14px;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: background 0.3s;
        }
        button:hover { background: #5568d3; }
        button:disabled {
          background: #ccc;
          cursor: not-allowed;
        }
        .message {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: none;
        }
        .message.success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }
        .message.error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }
        .message.visible { display: block; }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>üîê Reset Password</h1>
        <div id="message" class="message"></div>
        <form id="resetForm">
          <div class="form-group">
            <label for="password">New Password</label>
            <input type="password" id="password" name="password" required minlength="6"
                   placeholder="Enter new password (min 6 characters)">
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6"
                   placeholder="Confirm new password">
          </div>
          <button type="submit" id="submitBtn">Reset Password</button>
        </form>
      </div>

      <script>
        const form = document.getElementById('resetForm');
        const message = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const token = '${token}';

        function showMessage(text, isError) {
          message.textContent = text;
          message.className = 'message visible ' + (isError ? 'error' : 'success');
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const password = document.getElementById('password').value;
          const confirmPassword = document.getElementById('confirmPassword').value;

          if (password !== confirmPassword) {
            showMessage('Passwords do not match', true);
            return;
          }

          if (password.length < 6) {
            showMessage('Password must be at least 6 characters', true);
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = 'Resetting...';

          try {
            const response = await fetch('/api/auth/reset-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, newPassword: password })
            });

            const data = await response.json();

            if (data.success) {
              showMessage(data.message, false);
              form.reset();
              setTimeout(() => {
                window.location.href = '/';
              }, 2000);
            } else {
              showMessage(data.message, true);
              submitBtn.disabled = false;
              submitBtn.textContent = 'Reset Password';
            }
          } catch (error) {
            showMessage('Network error. Please try again.', true);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Reset Password';
          }
        });
      </script>
    </body>
    </html>
  `);
});

// ===== STEP 5: Cleanup expired tokens (run periodically) =====
// Add this function and call it on server start + periodically

function cleanupExpiredTokens() {
  const now = Math.floor(Date.now() / 1000);
  const result = db.exec('DELETE FROM password_reset_tokens WHERE expires_at < ?', [now]);
  console.log('[DB] Cleaned up expired password reset tokens');
}

// Run cleanup on server start
cleanupExpiredTokens();

// Run cleanup every hour
setInterval(cleanupExpiredTokens, 60 * 60 * 1000);

// ===== INSTALLATION INSTRUCTIONS =====
// 1. SSH into Synology: ssh -p 222 administrator@192.168.1.222
// 2. Navigate to app directory: cd /volume1/web/chinese-word-map
// 3. Install Resend: npm install resend
// 4. Get Resend API key from https://resend.com/api-keys
// 5. Add domain zhongmap.com in Resend dashboard and verify DNS records
// 6. Copy all code above into server-synology.js at appropriate locations
// 7. Replace 're_YOUR_API_KEY_HERE' with actual Resend API key
// 8. Restart server:
//    sudo pkill -9 -f 'node.*server-synology'
//    sudo nohup /usr/local/bin/node server-synology.js > server.log 2>&1 &
// 9. Test by visiting https://chinese-app.synology.me/reset-password?token=test
