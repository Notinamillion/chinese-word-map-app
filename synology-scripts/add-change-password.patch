// Add change password endpoint for logged-in users
// TO BE APPLIED: 2026-01-04

// Add this endpoint after the forgot-password endpoint in server-synology.js:

// POST /api/auth/change-password - Change password for logged-in user
app.post('/api/auth/change-password', requireAuth, function(req, res) {
    try {
        const oldPassword = req.body.oldPassword;
        const newPassword = req.body.newPassword;
        const userId = req.session.userId;

        if (!oldPassword || !newPassword) {
            return res.status(400).json({
                success: false,
                message: 'Both old and new passwords are required'
            });
        }

        if (newPassword.length < 6) {
            return res.status(400).json({
                success: false,
                message: 'New password must be at least 6 characters'
            });
        }

        // Get current user data
        const userResult = db.exec('SELECT password FROM users WHERE id = ?', [userId]);

        if (!userResult.length || !userResult[0].values.length) {
            return res.status(404).json({
                success: false,
                message: 'User not found'
            });
        }

        const currentPasswordHash = userResult[0].values[0][0];

        // Verify old password
        const bcrypt = require('bcryptjs');
        const isMatch = bcrypt.compareSync(oldPassword, currentPasswordHash);

        if (!isMatch) {
            return res.status(401).json({
                success: false,
                message: 'Current password is incorrect'
            });
        }

        // Hash new password
        const newPasswordHash = bcrypt.hashSync(newPassword, 10);

        // Update password
        db.exec(
            'UPDATE users SET password = ? WHERE id = ?',
            [newPasswordHash, userId]
        );

        console.log('[AUTH] Password changed for user ID:', userId);

        res.json({
            success: true,
            message: 'Password changed successfully'
        });
    } catch (error) {
        console.error('[AUTH] Change password error:', error);
        res.status(500).json({
            success: false,
            message: 'Server error'
        });
    }
});

// ===== INSTALLATION INSTRUCTIONS =====
// 1. Add the code above to server-synology.js after the forgot-password endpoint
// 2. Upload to Synology:
//    pscp -P 222 -pw "Roc1725s!" synology-scripts/server-current.js administrator@192.168.1.222:/volume1/web/chinese-word-map/server-synology.js
// 3. Restart server:
//    sudo pkill -9 -f 'node.*server-synology'
//    sudo nohup /usr/local/bin/node server-synology.js > server.log 2>&1 &
